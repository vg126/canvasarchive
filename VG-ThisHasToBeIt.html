<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRBanger Enhanced Legal Research System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-[#5D5CDE] mb-2">🎯 DRBanger Enhanced Legal Research System</h1>
            <p class="text-gray-600 dark:text-gray-400">6-Bot Manual Workflow: SST Application → Web Adversary → International Law Validation → ICC Insight Extraction → Web Verification → Dynamic SST Generation</p>
        </div>

        <!-- Non-intrusive Error Toast -->
        <div id="errorToast" class="fixed top-4 right-4 z-50 hidden">
            <div class="bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg max-w-sm">
                <div id="errorToastMessage" class="text-sm"></div>
            </div>
        </div>

        <!-- Copy Success Toast -->
        <div id="copyToast" class="fixed top-4 right-4 z-50 hidden">
            <div class="bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg max-w-sm">
                <div class="text-sm">📋 Copied to clipboard</div>
            </div>
        </div>

        <!-- Floating Next Bot Button -->
        <div id="floatingNextBot" class="fixed top-4 left-4 z-50">
            <button id="nextBotButton" class="bg-[#5D5CDE] hover:bg-[#4A4BC7] text-white px-4 py-3 rounded-lg shadow-lg transition-all duration-200 flex items-center space-x-2 relative">
                <span id="nextBotText">▶️ Start Bot 1</span>
                <div id="nextBotSpinner" class="hidden">
                    <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                </div>
            </button>
        </div>

        <!-- State Success Toast -->
        <div id="stateToast" class="fixed top-4 right-4 z-50 hidden">
            <div class="bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg max-w-sm">
                <div id="stateToastMessage" class="text-sm"></div>
            </div>
        </div>

        <!-- Load State Modal -->
        <div id="loadStateModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden flex flex-col">
                <h3 class="text-lg font-semibold mb-4">📁 Load State</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Paste the saved state JSON below. This will replace all current content.</p>
                <textarea 
                    id="loadStateTextarea" 
                    class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base resize-none flex-1 min-h-[300px]"
                    placeholder="Paste your DRBanger state JSON here..."
                ></textarea>
                <div class="flex justify-end space-x-3 mt-4">
                    <button id="cancelLoadState" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">Cancel</button>
                    <button id="confirmLoadState" class="px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded">Load State</button>
                </div>
            </div>
        </div>

        <!-- Input Section -->
        <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">📝 Input Configuration</h2>
                <div class="flex space-x-2">
                    <button id="saveState" class="p-2 text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200" title="Save State">
                        💾
                    </button>
                    <button id="loadState" class="p-2 text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200" title="Load State">
                        📁
                    </button>
                    <button id="downloadFlow" class="p-2 text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200" title="Download Flow">
                        📄
                    </button>
                </div>
            </div>

            <!-- Unified File Upload Section -->
            <div class="mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                <h3 class="font-semibold mb-3 text-blue-800 dark:text-blue-200">📁 File Upload Center</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="text-center">
                        <label class="block text-sm font-medium mb-2">Legal Texts Database</label>
                        <input type="file" id="legalTextFile" accept=".json" class="w-full text-sm">
                        <p class="text-xs text-gray-500 mt-1">JSON array of legal texts</p>
                    </div>
                    <div class="text-center">
                        <label class="block text-sm font-medium mb-2">SST Techniques Database</label>
                        <input type="file" id="sstDatabaseFile" accept=".json" class="w-full text-sm">
                        <p class="text-xs text-gray-500 mt-1">Hierarchical SST database</p>
                    </div>
                    <div class="text-center">
                        <label class="block text-sm font-medium mb-2">Bot Prompts Database</label>
                        <input type="file" id="botPromptsFile" accept=".json" class="w-full text-sm">
                        <p class="text-xs text-gray-500 mt-1">Bot prompt templates</p>
                    </div>
                </div>
                <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div>
                        <span id="legalTextDatabaseStatus" class="text-gray-600 dark:text-gray-400">No database loaded</span>
                    </div>
                    <div>
                        <span id="sstDatabaseStatus" class="text-gray-600 dark:text-gray-400">No database loaded</span>
                    </div>
                    <div>
                        <span id="botPromptsDatabaseStatus" class="text-gray-600 dark:text-gray-400">No database loaded</span>
                    </div>
                </div>
            </div>

            <!-- Legal Text Input -->
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Legal Text (e.g., ICC Article 17)</label>
                <div class="relative">
                    <textarea 
                        id="legalText" 
                        class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base resize-vertical"
                        rows="4"
                        placeholder="Enter the legal text you want to analyze..."
                    ></textarea>
                    <div class="absolute top-2 right-2 flex space-x-1">
                        <button id="copyLegalText" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Copy to Clipboard">📋</button>
                        <button id="feedLegalText" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Feed to Preview">📤</button>
                    </div>
                </div>
                
                <!-- Legal Text Database Controls -->
                <div class="mt-3 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                    <h4 class="font-semibold mb-2 text-blue-800 dark:text-blue-200 text-sm">📖 Legal Text Database</h4>
                    <div class="flex items-center space-x-3 mt-2">
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600 dark:text-gray-400">Find by ID:</label>
                            <input 
                                type="text" 
                                id="legalTextSearch" 
                                class="w-20 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-sm"
                                placeholder="ID"
                            >
                            <button 
                                id="loadLegalTextById"
                                class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-sm"
                                disabled
                            >
                                Load
                            </button>
                        </div>
                        <button 
                            id="randomizeLegalText"
                            class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition-colors text-sm"
                            disabled
                        >
                            🎲 Random
                        </button>
                    </div>
                </div>
            </div>

            <!-- SST Technique Input -->
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">SST Technique</label>
                <div class="relative">
                    <textarea 
                        id="sstCapsule" 
                        class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base resize-vertical"
                        rows="3"
                        placeholder="Enter an SST technique or load from JSON database..."
                    ></textarea>
                    <div class="absolute top-2 right-2 flex space-x-1">
                        <button id="copySSTCapsule" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Copy to Clipboard">📋</button>
                        <button id="feedSSTCapsule" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Feed to Preview">📤</button>
                    </div>
                </div>
                
                <!-- Manual SST Selection -->
                <div class="mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                    <h3 class="font-semibold mb-3 text-blue-800 dark:text-blue-200">🎯 Manual SST Selection</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                        <div>
                            <label class="block text-sm font-medium mb-2">Domain</label>
                            <select id="sstDomainSelect" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-base">
                                <option value="">Select a domain...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Technique</label>
                            <select id="sstTechniqueSelect" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-base" disabled>
                                <option value="">Select a technique...</option>
                            </select>
                        </div>
                    </div>
                    <button 
                        id="sampleSSTBtn"
                        class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-sm rounded hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors"
                    >
                        🎲 Sample Random SST
                    </button>
                </div>
            </div>

            <!-- Bot Selectors -->
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Bot 1: SST Application</label>
                    <select id="bot1" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-base">
                        <option value="GPT-4.1" selected>GPT-4.1</option>
                        <option value="GPT-5-Chat">GPT-5-Chat</option>
                        <option value="DeepSeek-V3">DeepSeek-V3</option>
                        <option value="Deepseek-V3-FW">Deepseek-V3-FW</option>
                        <option value="Qwen3-235B-2507-FW">Qwen3-235B-2507-FW</option>
                        <option value="Claude-Sonnet-4">Claude-Sonnet-4</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Bot 2: Web Adversary</label>
                    <select id="bot2" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-base">
                        <option value="Claude-Opus-4-Search" selected>Claude-Opus-4-Search</option>
                        <option value="Grok-4">Grok-4</option>
                        <option value="Perplexity-Sonar-Rsn-Pro">Perplexity-Sonar-Rsn-Pro</option>
                        <option value="Perplexity-Sonar-Pro">Perplexity-Sonar-Pro</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Bot 3: International Law SST</label>
                    <select id="bot3" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-base">
                        <option value="Claude-Opus-4.1" selected>Claude-Opus-4.1</option>
                        <option value="Claude-Opus-4-Reasoning">Claude-Opus-4-Reasoning</option>
                        <option value="Gemini-2.5-Pro">Gemini-2.5-Pro</option>
                        <option value="Grok-4">Grok-4</option>
                        <option value="o3-pro">o3-pro</option>
                        <option value="Claude-Sonnet-4-Reasoning">Claude-Sonnet-4-Reasoning</option>
                        <option value="Kimi-K2-Instruct-N">Kimi-K2-Instruct-N</option>
                        <option value="Claude-Opus-4-Search">Claude-Opus-4-Search</option>
                        <option value="Claude-Sonnet-4-Search">Claude-Sonnet-4-Search</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Bot 4: ICC Insight Extractor</label>
                    <select id="bot4" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-base">
                        <option value="Claude-Opus-4.1" selected>Claude-Opus-4.1</option>
                        <option value="Gemini-2.5-Pro">Gemini-2.5-Pro</option>
                        <option value="o1">o1</option>
                        <option value="o3">o3</option>
                        <option value="o3-pro">o3-pro</option>
                        <option value="DeepSeek-R1">DeepSeek-R1</option>
                        <option value="Kimi-K2-T">Kimi-K2-T</option>
                        <option value="GPT-5">GPT-5</option>
                        <option value="Claude-Sonnet-4-Search">Claude-Sonnet-4-Search</option>
                        <option value="Claude-Opus-4-Search">Claude-Opus-4-Search</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Bot 5: Web Verification</label>
                    <select id="bot5" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-base">
                        <option value="Gemini-2.5-Pro" selected>Gemini-2.5-Pro</option>
                        <option value="Gemini-2.5-Flash">Gemini-2.5-Flash</option>
                        <option value="Claude-Opus-4-Search">Claude-Opus-4-Search</option>
                        <option value="Claude-Sonnet-4-Search">Claude-Sonnet-4-Search</option>
                        <option value="Grok-4">Grok-4</option>
                        <option value="Perplexity-Sonar-Rsn-Pro">Perplexity-Sonar-Rsn-Pro</option>
                        <option value="GPT-Researcher">GPT-Researcher</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Bot 6: Dynamic SST Generator</label>
                    <select id="bot6" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-base">
                        <option value="Claude-Opus-4.1" selected>Claude-Opus-4.1</option>
                        <option value="Claude-Opus-4-Reasoning">Claude-Opus-4-Reasoning</option>
                        <option value="Gemini-2.5-Pro">Gemini-2.5-Pro</option>
                        <option value="Grok-4">Grok-4</option>
                        <option value="o3-pro">o3-pro</option>
                        <option value="Claude-Sonnet-4-Reasoning">Claude-Sonnet-4-Reasoning</option>
                        <option value="Kimi-K2-Instruct-N">Kimi-K2-Instruct-N</option>
                        <option value="Claude-Sonnet-4-Search">Claude-Sonnet-4-Search</option>
                        <option value="Claude-Opus-4-Search">Claude-Opus-4-Search</option>
                    </select>
                </div>
            </div>

            <!-- Bot 6 Dynamic SST Generator Panel -->
            <div class="mb-4 p-4 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg border border-indigo-200 dark:border-indigo-800">
                <h3 class="font-semibold mb-3 text-indigo-800 dark:text-indigo-200">🎯 Bot 6: Dynamic SST Generator</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                    <div>
                        <label class="block text-sm font-medium mb-2">Custom Domain (Optional)</label>
                        <input 
                            type="text" 
                            id="customDomain" 
                            class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-base"
                            placeholder="Enter specific domain for SST generation..."
                        >
                    </div>
                    <div class="flex items-end">
                        <button 
                            id="executeBot6Panel"
                            class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition-colors text-sm w-full relative"
                        >
                            <span id="executeBot6PanelText">🎯 Generate Optimized SST</span>
                            <div id="executeBot6PanelSpinner" class="hidden absolute inset-0 flex items-center justify-center">
                                <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                            </div>
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Communication & Instructions (Optional)</label>
                    <textarea 
                        id="customInstruction" 
                        class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-base resize-vertical"
                        rows="3"
                        placeholder="Provide specific feedback, corrections, or guidance for SST generation..."
                    ></textarea>
                </div>
            </div>

            <!-- Workflow Status -->
            <div class="mb-4 p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800">
                <h3 class="font-semibold mb-2 text-green-800 dark:text-green-200">🔄 Workflow Progress</h3>
                <div class="flex flex-wrap gap-2">
                    <div class="flex items-center">
                        <span id="step1Status" class="px-3 py-1 rounded-full text-xs bg-gray-200 dark:bg-gray-700">1. SST Application</span>
                        <div id="step1Spinner" class="hidden ml-2 animate-spin rounded-full h-4 w-4 border-2 border-blue-500 border-t-transparent"></div>
                    </div>
                    <div class="flex items-center">
                        <span id="step2Status" class="px-3 py-1 rounded-full text-xs bg-gray-200 dark:bg-gray-700">2. Web Adversary</span>
                        <div id="step2Spinner" class="hidden ml-2 animate-spin rounded-full h-4 w-4 border-2 border-green-500 border-t-transparent"></div>
                    </div>
                    <div class="flex items-center">
                        <span id="step3Status" class="px-3 py-1 rounded-full text-xs bg-gray-200 dark:bg-gray-700">3. International Law</span>
                        <div id="step3Spinner" class="hidden ml-2 animate-spin rounded-full h-4 w-4 border-2 border-purple-500 border-t-transparent"></div>
                    </div>
                    <div class="flex items-center">
                        <span id="step4Status" class="px-3 py-1 rounded-full text-xs bg-gray-200 dark:bg-gray-700">4. ICC Insights</span>
                        <div id="step4Spinner" class="hidden ml-2 animate-spin rounded-full h-4 w-4 border-2 border-red-500 border-t-transparent"></div>
                    </div>
                    <div class="flex items-center">
                        <span id="step5Status" class="px-3 py-1 rounded-full text-xs bg-gray-200 dark:bg-gray-700">5. Web Verification</span>
                        <div id="step5Spinner" class="hidden ml-2 animate-spin rounded-full h-4 w-4 border-2 border-teal-500 border-t-transparent"></div>
                    </div>
                    <div class="flex items-center">
                        <span id="step6Status" class="px-3 py-1 rounded-full text-xs bg-gray-200 dark:bg-gray-700">6. SST Generation</span>
                        <div id="step6Spinner" class="hidden ml-2 animate-spin rounded-full h-4 w-4 border-2 border-indigo-500 border-t-transparent"></div>
                    </div>
                </div>
            </div>

            <!-- Manual Bot Controls -->
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                <button id="executeBot1" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-sm relative">
                    <span id="executeBot1Text">▶️ Bot 1</span>
                    <div id="executeBot1Spinner" class="hidden absolute inset-0 flex items-center justify-center">
                        <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                    </div>
                </button>
                <button id="executeBot2" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors text-sm relative">
                    <span id="executeBot2Text">▶️ Bot 2</span>
                    <div id="executeBot2Spinner" class="hidden absolute inset-0 flex items-center justify-center">
                        <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                    </div>
                </button>
                <button id="executeBot3" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors text-sm relative">
                    <span id="executeBot3Text">▶️ Bot 3</span>
                    <div id="executeBot3Spinner" class="hidden absolute inset-0 flex items-center justify-center">
                        <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                    </div>
                </button>
                <button id="executeBot4" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors text-sm relative">
                    <span id="executeBot4Text">▶️ Bot 4</span>
                    <div id="executeBot4Spinner" class="hidden absolute inset-0 flex items-center justify-center">
                        <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                    </div>
                </button>
                <button id="executeBot5" class="px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700 transition-colors text-sm relative">
                    <span id="executeBot5Text">▶️ Bot 5</span>
                    <div id="executeBot5Spinner" class="hidden absolute inset-0 flex items-center justify-center">
                        <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                    </div>
                </button>
                <button id="executeBot6" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition-colors text-sm relative">
                    <span id="executeBot6Text">▶️ Bot 6</span>
                    <div id="executeBot6Spinner" class="hidden absolute inset-0 flex items-center justify-center">
                        <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                    </div>
                </button>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="space-y-6">
            <!-- Bot 1 Results -->
            <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-6">
                <h3 class="text-lg font-semibold flex items-center justify-between mb-3">
                    <div class="flex items-center">
                        <span class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm mr-3">1</span>
                        🔍 SST Mechanical Application Bot
                        <div class="ml-4 flex items-center space-x-2">
                            <input 
                                type="text" 
                                id="bot1PromptSearch" 
                                class="w-16 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-xs"
                                placeholder="ID"
                            >
                            <button 
                                id="loadBot1Prompt"
                                class="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-xs"
                                disabled
                            >
                                Load
                            </button>
                            <button 
                                id="randomBot1Prompt"
                                class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition-colors text-xs"
                                disabled
                                title="Random Prompt"
                            >
                                🎲
                            </button>
                        </div>
                    </div>
                    <div class="flex space-x-1 items-center">
                        <label class="flex items-center cursor-pointer" title="Mark as Complete">
                            <input type="checkbox" id="manualCompleteBot1" class="mr-1">
                            <span class="text-xs text-gray-500">✓ Done</span>
                        </label>
                        <button id="copyBot1" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Copy to Clipboard">📋</button>
                        <button id="downloadBot1" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Download as Markdown">💾</button>
                        <button id="feedBot1" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Feed to Preview">📤</button>
                        <button id="clearBot1" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Clear Output">🗑️</button>
                    </div>
                </h3>
                <div id="bot1PromptStatus" class="text-xs text-gray-500 mb-2">Default prompt</div>
                <div id="bot1Status" class="text-sm text-gray-600 dark:text-gray-400 mb-2"></div>
                <div id="bot1Output" class="prose dark:prose-invert max-w-none bg-white dark:bg-gray-800 p-4 rounded border min-h-[50px] max-h-[600px] overflow-y-auto"></div>
            </div>

            <!-- Bot 2 Results -->
            <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-6">
                <h3 class="text-lg font-semibold flex items-center justify-between mb-3">
                    <div class="flex items-center">
                        <span class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center text-sm mr-3">2</span>
                        ⚡ Web Adversary Bot
                        <div class="ml-4 flex items-center space-x-2">
                            <input 
                                type="text" 
                                id="bot2PromptSearch" 
                                class="w-16 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-xs"
                                placeholder="ID"
                            >
                            <button 
                                id="loadBot2Prompt"
                                class="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-xs"
                                disabled
                            >
                                Load
                            </button>
                            <button 
                                id="randomBot2Prompt"
                                class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition-colors text-xs"
                                disabled
                                title="Random Prompt"
                            >
                                🎲
                            </button>
                        </div>
                    </div>
                    <div class="flex space-x-1 items-center">
                        <label class="flex items-center cursor-pointer" title="Mark as Complete">
                            <input type="checkbox" id="manualCompleteBot2" class="mr-1">
                            <span class="text-xs text-gray-500">✓ Done</span>
                        </label>
                        <button id="copyBot2" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Copy to Clipboard">📋</button>
                        <button id="downloadBot2" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Download as Markdown">💾</button>
                        <button id="feedBot2" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Feed to Preview">📤</button>
                        <button id="clearBot2" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Clear Output">🗑️</button>
                    </div>
                </h3>
                <div id="bot2PromptStatus" class="text-xs text-gray-500 mb-2">Default prompt</div>
                <div id="bot2Status" class="text-sm text-gray-600 dark:text-gray-400 mb-2"></div>
                <div id="bot2Output" class="prose dark:prose-invert max-w-none bg-white dark:bg-gray-800 p-4 rounded border min-h-[50px] max-h-[600px] overflow-y-auto"></div>
            </div>

            <!-- Bot 3 Results -->
            <div class="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-6">
                <h3 class="text-lg font-semibold flex items-center justify-between mb-3">
                    <div class="flex items-center">
                        <span class="w-8 h-8 bg-purple-500 text-white rounded-full flex items-center justify-center text-sm mr-3">3</span>
                        🧪 International Law SST Applicator Bot
                        <div class="ml-4 flex items-center space-x-2">
                            <input 
                                type="text" 
                                id="bot3PromptSearch" 
                                class="w-16 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-xs"
                                placeholder="ID"
                            >
                            <button 
                                id="loadBot3Prompt"
                                class="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-xs"
                                disabled
                            >
                                Load
                            </button>
                            <button 
                                id="randomBot3Prompt"
                                class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition-colors text-xs"
                                disabled
                                title="Random Prompt"
                            >
                                🎲
                            </button>
                        </div>
                    </div>
                    <div class="flex space-x-1 items-center">
                        <label class="flex items-center cursor-pointer" title="Mark as Complete">
                            <input type="checkbox" id="manualCompleteBot3" class="mr-1">
                            <span class="text-xs text-gray-500">✓ Done</span>
                        </label>
                        <button id="copyBot3" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Copy to Clipboard">📋</button>
                        <button id="downloadBot3" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Download as Markdown">💾</button>
                        <button id="feedBot3" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Feed to Preview">📤</button>
                        <button id="clearBot3" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Clear Output">🗑️</button>
                    </div>
                </h3>
                <div id="bot3PromptStatus" class="text-xs text-gray-500 mb-2">Default prompt</div>
                <div id="bot3Status" class="text-sm text-gray-600 dark:text-gray-400 mb-2"></div>
                <div id="bot3Output" class="prose dark:prose-invert max-w-none bg-white dark:bg-gray-800 p-4 rounded border min-h-[50px] max-h-[600px] overflow-y-auto"></div>
            </div>

            <!-- Bot 4 Results -->
            <div class="bg-red-50 dark:bg-red-900/20 rounded-lg p-6">
                <h3 class="text-lg font-semibold flex items-center justify-between mb-3">
                    <div class="flex items-center">
                        <span class="w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center text-sm mr-3">4</span>
                        ⚡ ICC Insight Extractor Bot
                        <div class="ml-4 flex items-center space-x-2">
                            <input 
                                type="text" 
                                id="bot4PromptSearch" 
                                class="w-16 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-xs"
                                placeholder="ID"
                            >
                            <button 
                                id="loadBot4Prompt"
                                class="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-xs"
                                disabled
                            >
                                Load
                            </button>
                            <button 
                                id="randomBot4Prompt"
                                class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition-colors text-xs"
                                disabled
                                title="Random Prompt"
                            >
                                🎲
                            </button>
                        </div>
                    </div>
                    <div class="flex space-x-1 items-center">
                        <label class="flex items-center cursor-pointer" title="Mark as Complete">
                            <input type="checkbox" id="manualCompleteBot4" class="mr-1">
                            <span class="text-xs text-gray-500">✓ Done</span>
                        </label>
                        <button id="copyBot4" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Copy to Clipboard">📋</button>
                        <button id="downloadBot4" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Download as Markdown">💾</button>
                        <button id="feedBot4" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Feed to Preview">📤</button>
                        <button id="clearBot4" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Clear Output">🗑️</button>
                    </div>
                </h3>
                <div id="bot4PromptStatus" class="text-xs text-gray-500 mb-2">Default prompt</div>
                <div id="bot4Status" class="text-sm text-gray-600 dark:text-gray-400 mb-2"></div>
                <div id="bot4Output" class="prose dark:prose-invert max-w-none bg-white dark:bg-gray-800 p-4 rounded border min-h-[50px] max-h-[600px] overflow-y-auto"></div>
            </div>

            <!-- Bot 5 Results -->
            <div class="bg-teal-50 dark:bg-teal-900/20 rounded-lg p-6">
                <h3 class="text-lg font-semibold flex items-center justify-between mb-3">
                    <div class="flex items-center">
                        <span class="w-8 h-8 bg-teal-500 text-white rounded-full flex items-center justify-center text-sm mr-3">5</span>
                        🔍 Web Verification Bot
                        <div class="ml-4 flex items-center space-x-2">
                            <input 
                                type="text" 
                                id="bot5PromptSearch" 
                                class="w-16 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-xs"
                                placeholder="ID"
                            >
                            <button 
                                id="loadBot5Prompt"
                                class="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-xs"
                                disabled
                            >
                                Load
                            </button>
                            <button 
                                id="randomBot5Prompt"
                                class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition-colors text-xs"
                                disabled
                                title="Random Prompt"
                            >
                                🎲
                            </button>
                        </div>
                    </div>
                    <div class="flex space-x-1 items-center">
                        <label class="flex items-center cursor-pointer" title="Mark as Complete">
                            <input type="checkbox" id="manualCompleteBot5" class="mr-1">
                            <span class="text-xs text-gray-500">✓ Done</span>
                        </label>
                        <button id="copyBot5" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Copy to Clipboard">📋</button>
                        <button id="downloadBot5" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Download as Markdown">💾</button>
                        <button id="feedBot5" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Feed to Preview">📤</button>
                        <button id="clearBot5" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Clear Output">🗑️</button>
                    </div>
                </h3>
                <div id="bot5PromptStatus" class="text-xs text-gray-500 mb-2">Default prompt</div>
                <div id="bot5Status" class="text-sm text-gray-600 dark:text-gray-400 mb-2"></div>
                <div id="bot5Output" class="prose dark:prose-invert max-w-none bg-white dark:bg-gray-800 p-4 rounded border min-h-[50px] max-h-[600px] overflow-y-auto"></div>
            </div>

            <!-- Bot 6 Results -->
            <div class="bg-indigo-50 dark:bg-indigo-900/20 rounded-lg p-6">
                <h3 class="text-lg font-semibold flex items-center justify-between mb-3">
                    <div class="flex items-center">
                        <span class="w-8 h-8 bg-indigo-500 text-white rounded-full flex items-center justify-center text-sm mr-3">6</span>
                        🎯 Dynamic SST Generator Bot
                        <div class="ml-4 flex items-center space-x-2">
                            <input 
                                type="text" 
                                id="bot6PromptSearch" 
                                class="w-16 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-xs"
                                placeholder="ID"
                            >
                            <button 
                                id="loadBot6Prompt"
                                class="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-xs"
                                disabled
                            >
                                Load
                            </button>
                            <button 
                                id="randomBot6Prompt"
                                class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition-colors text-xs"
                                disabled
                                title="Random Prompt"
                            >
                                🎲
                            </button>
                        </div>
                    </div>
                    <div class="flex space-x-1 items-center">
                        <label class="flex items-center cursor-pointer" title="Mark as Complete">
                            <input type="checkbox" id="manualCompleteBot6" class="mr-1">
                            <span class="text-xs text-gray-500">✓ Done</span>
                        </label>
                        <button id="copyBot6" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Copy to Clipboard">📋</button>
                        <button id="downloadBot6" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Download as Markdown">💾</button>
                        <button id="feedBot6" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Feed to Preview">📤</button>
                        <button id="clearBot6" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Clear Output">🗑️</button>
                    </div>
                </h3>
                <div id="bot6PromptStatus" class="text-xs text-gray-500 mb-2">Default prompt</div>
                <div id="bot6Status" class="text-sm text-gray-600 dark:text-gray-400 mb-2"></div>
                <div id="bot6Output" class="prose dark:prose-invert max-w-none bg-white dark:bg-gray-800 p-4 rounded border min-h-[50px] max-h-[600px] overflow-y-auto"></div>
            </div>
        </div>

        <!-- Live Logging System -->
        <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 mt-6">
            <div class="flex items-center justify-between cursor-pointer" id="loggingToggle">
                <div class="flex items-center">
                    <span id="loggingArrow" class="text-xl mr-2 transform transition-transform duration-200">▼</span>
                    <h2 class="text-xl font-semibold">📊 Live Activity Log</h2>
                    <span id="logCount" class="ml-2 px-2 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 text-xs rounded-full">0 activities</span>
                </div>
                
                <!-- Logging Controls -->
                <div class="flex items-center space-x-3 text-sm">
                    <div class="flex items-center space-x-2">
                        <label class="text-gray-600 dark:text-gray-400">Font:</label>
                        <select id="loggingFont" class="px-2 py-1 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-xs">
                            <option value="ui-sans-serif">Default</option>
                            <option value="ui-serif">Serif</option>
                            <option value="ui-monospace">Mono</option>
                            <option value="Georgia">Georgia</option>
                            <option value="Times">Times</option>
                            <option value="Courier">Courier</option>
                        </select>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <label class="text-gray-600 dark:text-gray-400">Size:</label>
                        <select id="loggingSize" class="px-2 py-1 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-xs">
                            <option value="text-xs">XS</option>
                            <option value="text-sm" selected>SM</option>
                            <option value="text-base">Base</option>
                            <option value="text-lg">LG</option>
                            <option value="text-xl">XL</option>
                        </select>
                    </div>
                    
                    <button id="clearAllLogs" class="px-3 py-1 bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 rounded text-xs hover:bg-red-200 dark:hover:bg-red-800" title="Clear All Logs">
                        🗑️ Clear Logs
                    </button>
                </div>
            </div>
            
            <div id="loggingContent" class="mt-4 space-y-2 max-h-[70vh] overflow-y-auto">
                <div id="loggingEmpty" class="text-gray-500 dark:text-gray-400 text-center py-8 italic">
                    No activity logged yet. Bot executions will appear here in real-time.
                </div>
            </div>
        </div>

        <!-- Error Display -->
        <div id="errorSection" class="hidden bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 mt-6">
            <h3 class="text-red-800 dark:text-red-200 font-semibold mb-2">❌ Error</h3>
            <div id="errorMessage" class="text-red-700 dark:text-red-300"></div>
        </div>
    </div>

    <script>
        // ===== CENTRAL STATE MANAGEMENT =====
        window.DRBangerState = {};

        // ===== PREVIEW SETTINGS =====
        let previewSettings = {
            font: 'ui-sans-serif',
            size: 'text-sm',
            theme: 'default'
        };

        // ===== ERROR HANDLING SYSTEM =====
        function showErrorToast(message) {
            console.error('[DRBanger Error]:', message);
            const toast = document.getElementById('errorToast');
            const toastMessage = document.getElementById('errorToastMessage');
            
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 5000);
        }

        function showStateToast(message) {
            console.log('[DRBanger State]:', message);
            const toast = document.getElementById('stateToast');
            const toastMessage = document.getElementById('stateToastMessage');
            
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        function showError(message) {
            showErrorToast(message);
            // Also log to old error system for fallback
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorSection').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('errorSection').classList.add('hidden');
            }, 5000);
        }

        // ===== PHASE 5: STATE MANAGEMENT SYSTEM =====
        
        function captureCurrentState() {
            const state = {
                version: "1.0",
                timestamp: new Date().toISOString(),
                phase: "Phase 5+ - Enhanced Preview",
                
                // Inputs
                inputs: {
                    legalText: document.getElementById('legalText').value,
                    sstCapsule: document.getElementById('sstCapsule').value,
                    customDomain: document.getElementById('customDomain').value,
                    customInstruction: document.getElementById('customInstruction').value
                },
                
                // Bot selections
                botSelections: {
                    bot1: document.getElementById('bot1').value,
                    bot2: document.getElementById('bot2').value,
                    bot3: document.getElementById('bot3').value,
                    bot4: document.getElementById('bot4').value,
                    bot5: document.getElementById('bot5').value,
                    bot6: document.getElementById('bot6').value
                },
                
                // Bot outputs and statuses
                botResults: {},
                
                // Workflow progress
                workflowProgress: {},
                
                // SST Database
                sstDatabase: sstDatabase,
                sstDatabaseStatus: {
                    text: document.getElementById('sstDatabaseStatus').textContent,
                    className: document.getElementById('sstDatabaseStatus').className
                },
                
                // Preview items and settings
                previewItems: previewItems,
                previewSettings: previewSettings
            };
            
            // Capture bot results
            for (let i = 1; i <= 6; i++) {
                const output = document.getElementById(`bot${i}Output`);
                const status = document.getElementById(`bot${i}Status`);
                
                state.botResults[`bot${i}`] = {
                    output: output ? output.innerHTML : '',
                    status: status ? status.textContent : '',
                    statusClassName: status ? status.className : ''
                };
            }
            
            // Capture workflow progress
            for (let i = 1; i <= 6; i++) {
                const stepStatus = document.getElementById(`step${i}Status`);
                if (stepStatus) {
                    state.workflowProgress[`step${i}`] = {
                        text: stepStatus.textContent,
                        className: stepStatus.className
                    };
                }
            }
            
            return state;
        }

        function restoreState(state) {
            try {
                console.log('[DRBanger] Restoring state:', state);
                
                // Restore inputs
                if (state.inputs) {
                    if (state.inputs.legalText !== undefined) {
                        document.getElementById('legalText').value = state.inputs.legalText;
                    }
                    if (state.inputs.sstCapsule !== undefined) {
                        document.getElementById('sstCapsule').value = state.inputs.sstCapsule;
                    }
                    if (state.inputs.customDomain !== undefined) {
                        document.getElementById('customDomain').value = state.inputs.customDomain;
                    }
                    if (state.inputs.customInstruction !== undefined) {
                        document.getElementById('customInstruction').value = state.inputs.customInstruction;
                    }
                }
                
                // Restore bot selections
                if (state.botSelections) {
                    for (let i = 1; i <= 6; i++) {
                        const botSelect = document.getElementById(`bot${i}`);
                        if (botSelect && state.botSelections[`bot${i}`]) {
                            botSelect.value = state.botSelections[`bot${i}`];
                        }
                    }
                }
                
                // Restore bot results
                if (state.botResults) {
                    for (let i = 1; i <= 6; i++) {
                        const outputDiv = document.getElementById(`bot${i}Output`);
                        const statusDiv = document.getElementById(`bot${i}Status`);
                        const botResult = state.botResults[`bot${i}`];
                        
                        if (outputDiv && botResult) {
                            outputDiv.innerHTML = botResult.output || '';
                            if (statusDiv) {
                                statusDiv.textContent = botResult.status || '';
                                statusDiv.className = botResult.statusClassName || 'text-sm text-gray-600 dark:text-gray-400 mb-2';
                            }
                        }
                    }
                }
                
                // Restore workflow progress
                if (state.workflowProgress) {
                    for (let i = 1; i <= 6; i++) {
                        const stepStatus = document.getElementById(`step${i}Status`);
                        const stepData = state.workflowProgress[`step${i}`];
                        
                        if (stepStatus && stepData) {
                            stepStatus.textContent = stepData.text;
                            stepStatus.className = stepData.className;
                        }
                    }
                }
                
                // Restore SST Database
                if (state.sstDatabase) {
                    sstDatabase = state.sstDatabase;
                    const statusElement = document.getElementById('sstDatabaseStatus');
                    if (state.sstDatabaseStatus && statusElement) {
                        statusElement.textContent = state.sstDatabaseStatus.text;
                        statusElement.className = state.sstDatabaseStatus.className;
                    }
                    initializeCascadingDropdowns();
                }
                
                // Preview system removed - keeping settings for compatibility
                if (state.previewSettings) {
                    previewSettings = state.previewSettings;
                }
                
                // Preview items no longer used - converted to logging
                
                console.log('[DRBanger] State restored successfully');
                return true;
                
            } catch (error) {
                console.error('[DRBanger] Error restoring state:', error);
                return false;
            }
        }

        function saveState() {
            try {
                const state = captureCurrentState();
                const stateJson = JSON.stringify(state, null, 2);
                
                navigator.clipboard.writeText(stateJson).then(() => {
                    console.log('[DRBanger] State saved to clipboard');
                    showStateToast('💾 State saved to clipboard');
                }).catch(err => {
                    console.error('[DRBanger] Failed to save state to clipboard:', err);
                    showErrorToast('Failed to save state to clipboard');
                });
                
            } catch (error) {
                console.error('[DRBanger] Error saving state:', error);
                showErrorToast('Error saving state');
            }
        }

        function loadState() {
            document.getElementById('loadStateModal').classList.remove('hidden');
            document.getElementById('loadStateTextarea').value = '';
        }

        function confirmLoadState() {
            const jsonText = document.getElementById('loadStateTextarea').value.trim();
            
            if (!jsonText) {
                showErrorToast('Please paste state JSON');
                return;
            }
            
            try {
                const state = JSON.parse(jsonText);
                const success = restoreState(state);
                
                if (success) {
                    showStateToast('📁 State loaded successfully');
                    document.getElementById('loadStateModal').classList.add('hidden');
                } else {
                    showErrorToast('Failed to restore state completely');
                }
                
            } catch (error) {
                console.error('[DRBanger] Invalid JSON:', error);
                showErrorToast('Invalid JSON format');
            }
        }

        function cancelLoadState() {
            document.getElementById('loadStateModal').classList.add('hidden');
        }

        // ===== LIVE LOGGING SYSTEM =====
        
        let loggingSettings = {
            font: 'ui-sans-serif',
            size: 'text-sm'
        };

        let logEntries = [];

        function addLogEntry(type, title, content, timestamp = null) {
            const logTimestamp = timestamp || new Date().toLocaleString();
            const entry = {
                id: Date.now(),
                type,
                title,
                content,
                timestamp: logTimestamp
            };
            
            logEntries.push(entry);
            addLogEntryToDOM(entry);
            updateLogCount();
            console.log(`[DRBanger] Logged ${type}:`, title);
        }

        function addLogEntryToDOM(entry) {
            const loggingContent = document.getElementById('loggingContent');
            const loggingEmpty = document.getElementById('loggingEmpty');
            
            if (loggingEmpty && !loggingEmpty.classList.contains('hidden')) {
                loggingEmpty.classList.add('hidden');
            }
            
            const entryDiv = document.createElement('div');
            entryDiv.className = `log-entry border-l-4 pl-4 py-2 mb-2`;
            entryDiv.style.fontFamily = loggingSettings.font;
            
            // Color coding by type
            let borderColor = 'border-gray-300';
            let bgColor = 'bg-gray-50 dark:bg-gray-800';
            let textColor = 'text-gray-700 dark:text-gray-300';
            
            switch (entry.type) {
                case 'bot_start':
                    borderColor = 'border-blue-500';
                    bgColor = 'bg-blue-50 dark:bg-blue-900/20';
                    textColor = 'text-blue-800 dark:text-blue-200';
                    break;
                case 'bot_input':
                    borderColor = 'border-green-500';
                    bgColor = 'bg-green-50 dark:bg-green-900/20';
                    textColor = 'text-green-800 dark:text-green-200';
                    break;
                case 'bot_output':
                    borderColor = 'border-purple-500';
                    bgColor = 'bg-purple-50 dark:bg-purple-900/20';
                    textColor = 'text-purple-800 dark:text-purple-200';
                    break;
                case 'bot_complete':
                    borderColor = 'border-green-600';
                    bgColor = 'bg-green-100 dark:bg-green-900/30';
                    textColor = 'text-green-900 dark:text-green-100';
                    break;
                case 'bot_error':
                    borderColor = 'border-red-500';
                    bgColor = 'bg-red-50 dark:bg-red-900/20';
                    textColor = 'text-red-800 dark:text-red-200';
                    break;
                case 'manual_complete':
                    borderColor = 'border-yellow-500';
                    bgColor = 'bg-yellow-50 dark:bg-yellow-900/20';
                    textColor = 'text-yellow-800 dark:text-yellow-200';
                    break;
                default:
                    borderColor = 'border-gray-300';
                    bgColor = 'bg-gray-50 dark:bg-gray-800';
                    textColor = 'text-gray-700 dark:text-gray-300';
            }
            
            entryDiv.className += ` ${borderColor} ${bgColor}`;
            
            const contentPreview = entry.content.length > 200 ? 
                entry.content.substring(0, 200) + '...' : entry.content;
            
            entryDiv.innerHTML = `
                <div class="flex justify-between items-start mb-1">
                    <div class="flex items-center space-x-2">
                        <span class="font-semibold ${loggingSettings.size} ${textColor}">${entry.title}</span>
                        <span class="text-xs text-gray-500 dark:text-gray-400">${entry.timestamp}</span>
                    </div>
                </div>
                <div class="text-sm ${textColor} font-mono whitespace-pre-wrap overflow-x-auto max-h-32 overflow-y-auto">
                    ${contentPreview}
                </div>
            `;
            
            loggingContent.appendChild(entryDiv);
            
            // Auto-scroll to bottom
            loggingContent.scrollTop = loggingContent.scrollHeight;
        }

        function updateLogCount() {
            const logCount = document.getElementById('logCount');
            if (logCount) {
                logCount.textContent = `${logEntries.length} activities`;
            }
        }

        function clearAllLogs() {
            logEntries = [];
            const loggingContent = document.getElementById('loggingContent');
            const logItems = loggingContent.querySelectorAll('.log-entry');
            logItems.forEach(item => item.remove());
            
            const loggingEmpty = document.getElementById('loggingEmpty');
            if (loggingEmpty) {
                loggingEmpty.classList.remove('hidden');
            }
            
            updateLogCount();
            showStateToast('🗑️ Activity log cleared');
        }

        function applyLoggingSettings() {
            const content = document.getElementById('loggingContent');
            if (content) {
                content.style.fontFamily = loggingSettings.font;
                // Reapply settings to all existing items
                const logItems = content.querySelectorAll('.log-entry');
                logItems.forEach(item => {
                    item.style.fontFamily = loggingSettings.font;
                });
            }
        }

        // ===== LOADING STATE MANAGEMENT =====
        function setLoadingState(botNumber, isLoading) {
            console.log(`[DRBanger] Setting loading state for Bot ${botNumber}:`, isLoading);
            
            // Button loading state
            const button = document.getElementById(`executeBot${botNumber}`);
            const buttonText = document.getElementById(`executeBot${botNumber}Text`);
            const buttonSpinner = document.getElementById(`executeBot${botNumber}Spinner`);
            
            if (button && buttonText && buttonSpinner) {
                if (isLoading) {
                    buttonText.classList.add('invisible');
                    buttonSpinner.classList.remove('hidden');
                } else {
                    buttonText.classList.remove('invisible');
                    buttonSpinner.classList.add('hidden');
                }
            }
            
            // Panel button loading state for Bot 6
            if (botNumber === 6) {
                const panelButton = document.getElementById('executeBot6Panel');
                const panelText = document.getElementById('executeBot6PanelText');
                const panelSpinner = document.getElementById('executeBot6PanelSpinner');
                
                if (panelButton && panelText && panelSpinner) {
                    if (isLoading) {
                        panelText.classList.add('invisible');
                        panelSpinner.classList.remove('hidden');
                    } else {
                        panelText.classList.remove('invisible');
                        panelSpinner.classList.add('hidden');
                    }
                }
            }
            
            // Workflow progress spinner
            const stepSpinner = document.getElementById(`step${botNumber}Spinner`);
            if (stepSpinner) {
                if (isLoading) {
                    stepSpinner.classList.remove('hidden');
                } else {
                    stepSpinner.classList.add('hidden');
                }
            }
        }

        // ===== CLEAR BUTTON FUNCTIONALITY =====
        function setupClearButtons() {
            for (let i = 1; i <= 6; i++) {
                const clearButton = document.getElementById(`clearBot${i}`);
                const outputDiv = document.getElementById(`bot${i}Output`);
                const statusDiv = document.getElementById(`bot${i}Status`);
                
                if (clearButton && outputDiv) {
                    clearButton.addEventListener('click', () => {
                        console.log(`[DRBanger] Clearing Bot ${i} output`);
                        outputDiv.innerHTML = '';
                        if (statusDiv) {
                            statusDiv.textContent = '';
                        }
                        updateStepStatus(`step${i}Status`, 'idle');
                    });
                }
            }
        }

        // ===== PHASE 4: COPY/DOWNLOAD/FEED SYSTEM =====
        
        // Copy functionality
        function showCopyToast() {
            const toast = document.getElementById('copyToast');
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 2000);
        }

        function getFormattedTimestamp() {
            const now = new Date();
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                           'July', 'August', 'September', 'October', 'November', 'December'];
            const month = months[now.getMonth()];
            const date = now.getDate();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            return `${month}${date}_${hours}${minutes}${seconds}`;
        }

        function createMetadata(type, content) {
            const timestamp = new Date().toLocaleString();
            return `---
Type: ${type}
Generated: ${timestamp}
DRBanger System: Phase 5+
---

${content}`;
        }

        function copyToClipboard(content, type) {
            const metadataContent = createMetadata(type, content);
            navigator.clipboard.writeText(metadataContent).then(() => {
                console.log(`[DRBanger] Copied ${type} to clipboard`);
                showCopyToast();
            }).catch(err => {
                console.error('[DRBanger] Copy failed:', err);
                showErrorToast('Copy failed');
            });
        }

        function downloadContent(content, filename, type) {
            const metadataContent = createMetadata(type, content);
            const blob = new Blob([metadataContent], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.log(`[DRBanger] Downloaded ${filename}`);
        }

        // Preview system removed - variables kept for compatibility
        let previewItems = [];

        // Setup copy/download/feed buttons for inputs
        function setupInputButtons() {
            // Legal Text buttons
            document.getElementById('copyLegalText').addEventListener('click', () => {
                const content = document.getElementById('legalText').value;
                if (content.trim()) {
                    copyToClipboard(content, 'Legal Text Input');
                } else {
                    showErrorToast('No legal text to copy');
                }
            });

            document.getElementById('feedLegalText').addEventListener('click', () => {
                const content = document.getElementById('legalText').value;
                if (content.trim()) {
                    addLogEntry('user_input', 'Legal Text Input', content);
                    showStateToast('📤 Legal text logged');
                } else {
                    showErrorToast('No legal text to feed');
                }
            });

            // SST Capsule buttons
            document.getElementById('copySSTCapsule').addEventListener('click', () => {
                const content = document.getElementById('sstCapsule').value;
                if (content.trim()) {
                    copyToClipboard(content, 'SST Technique');
                } else {
                    showErrorToast('No SST technique to copy');
                }
            });

            document.getElementById('feedSSTCapsule').addEventListener('click', () => {
                const content = document.getElementById('sstCapsule').value;
                if (content.trim()) {
                    addLogEntry('user_input', 'SST Technique Input', content);
                    showStateToast('📤 SST technique logged');
                } else {
                    showErrorToast('No SST technique to feed');
                }
            });
        }

        // Setup copy/download/feed buttons for bots
        function setupBotButtons() {
            for (let i = 1; i <= 6; i++) {
                const botNames = ['SST Application', 'Web Adversary', 'International Law SST', 'ICC Insight Extractor', 'Web Verification', 'Dynamic SST Generator'];
                
                // Copy button
                document.getElementById(`copyBot${i}`).addEventListener('click', () => {
                    const content = document.getElementById(`bot${i}Output`).textContent;
                    if (content.trim()) {
                        copyToClipboard(content, `Bot ${i}: ${botNames[i-1]}`);
                    } else {
                        showErrorToast(`No Bot ${i} output to copy`);
                    }
                });

                // Download button
                document.getElementById(`downloadBot${i}`).addEventListener('click', () => {
                    const content = document.getElementById(`bot${i}Output`).textContent;
                    if (content.trim()) {
                        const timestamp = getFormattedTimestamp();
                        const filename = `Bot${i}_${timestamp}.md`;
                        downloadContent(content, filename, `Bot ${i}: ${botNames[i-1]}`);
                    } else {
                        showErrorToast(`No Bot ${i} output to download`);
                    }
                });

                // Feed button
                document.getElementById(`feedBot${i}`).addEventListener('click', () => {
                    const content = document.getElementById(`bot${i}Output`).textContent;
                    if (content.trim()) {
                        addLogEntry('user_feed', `Bot ${i} Output`, content);
                        showStateToast(`📤 Bot ${i} output logged`);
                    } else {
                        showErrorToast(`No Bot ${i} output to feed`);
                    }
                });
            }
        }

        // Download Flow functionality
        function downloadFlow() {
            const timestamp = getFormattedTimestamp();
            const filename = `DRBanger_Flow_${timestamp}.md`;
            
            let flowContent = '# DRBanger Enhanced Legal Research System - Complete Flow\n\n';
            
            // Add inputs
            const legalText = document.getElementById('legalText').value.trim();
            const sstTechnique = document.getElementById('sstCapsule').value.trim();
            
            if (legalText) {
                flowContent += '## Legal Text Input\n\n' + legalText + '\n\n';
            }
            
            if (sstTechnique) {
                flowContent += '## SST Technique\n\n' + sstTechnique + '\n\n';
            }
            
            // Add bot outputs
            const botNames = ['SST Mechanical Application', 'Web Adversary', 'International Law SST Validation', 'ICC Insight Extraction', 'Web Verification', 'Dynamic SST Generation'];
            
            for (let i = 1; i <= 6; i++) {
                const content = document.getElementById(`bot${i}Output`).textContent.trim();
                if (content) {
                    flowContent += `## Bot ${i}: ${botNames[i-1]}\n\n${content}\n\n`;
                }
            }
            
            if (flowContent === '# DRBanger Enhanced Legal Research System - Complete Flow\n\n') {
                showErrorToast('No content available to download');
                return;
            }
            
            downloadContent(flowContent, filename, 'Complete DRBanger Flow');
        }

        // ===== SST DATABASE SYSTEM =====
        let sstDatabase = null;

        // SST Database file upload handler
        document.getElementById('sstDatabaseFile').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file && file.type === 'application/json') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        sstDatabase = data;
                        document.getElementById('sstDatabaseStatus').textContent = `Loaded ${countTechniques(data)} techniques from ${data.length} domains`;
                        document.getElementById('sstDatabaseStatus').className = 'text-sm text-green-600 dark:text-green-400';
                        initializeCascadingDropdowns();
                        console.log('[DRBanger] SST Database loaded successfully:', data);
                    } catch (error) {
                        console.error('[DRBanger] Failed to load SST database:', error);
                        showError('Invalid JSON file format');
                        document.getElementById('sstDatabaseStatus').textContent = 'Failed to load database';
                        document.getElementById('sstDatabaseStatus').className = 'text-sm text-red-600 dark:text-red-400';
                    }
                };
                reader.readAsText(file);
            }
        });

        function countTechniques(database) {
            return database.reduce((total, domain) => total + domain.techniques.length, 0);
        }

        // Random SST sampling
        function getRandomSST() {
            if (!sstDatabase || !Array.isArray(sstDatabase)) return null;
            
            const allTechniques = [];
            sstDatabase.forEach(domain => {
                domain.techniques.forEach(tech => {
                    allTechniques.push({
                        ...tech,
                        domain: domain.domain
                    });
                });
            });

            if (allTechniques.length === 0) return null;
            
            const randomTech = allTechniques[Math.floor(Math.random() * allTechniques.length)];
            return `**SST TECHNIQUE**: ${randomTech.name} (${randomTech.domain})\n**APPLICATION METHOD**: ${randomTech.method}`;
        }

        // ===== BOT PROMPT TEMPLATES =====
        const botPrompts = {
            bot1: (legalText, sstTechnique) => {
                return `ROLE: sst_mechanical_applicator
TASK: Apply the provided SST technique mechanically to legal text
LEGAL TEXT: ${legalText}

SST TECHNIQUE: ${sstTechnique}

INSTRUCTIONS:
1. Apply the SST technique MECHANICALLY to the legal text structure
2. Do NOT interpret legal meaning - treat text as raw material for transformation
3. Transform the legal text THROUGH the SST lens as if it were data/code/music/etc
4. Show exactly HOW the transformation changes the text's structure
5. Include confidence score (0-100) for the mechanical application

OUTPUT FORMAT: 
[SST Applied: <technique name>]
[Confidence: XX/100]

<Mechanical transformation of the legal text through the SST lens>`;
            },

            bot2: (bot1Output, legalText) => {
                return `ROLE: web_research_critic
TASK: Conduct research-backed demolition of SST application as methodologically invalid
BOT 1 OUTPUT: ${bot1Output}
ORIGINAL ICC TEXT: ${legalText}

MANDATE: You are the research-armed skeptic. Use web search to find evidence that demolishes this SST transformation. Your job is to show why this approach is fundamentally flawed using current legal scholarship and established interpretive methods. Research and demonstrate why this SST technique violates established legal interpretation principles. Find evidence of methodological standards, precedential requirements, and scholarly consensus that contradicts this approach. Show how courts actually interpret legal text versus this transformation method. Document the practical impossibility of implementing such interpretive techniques in real legal proceedings. Your criticism should be devastating but research-backed - use web search to find the ammunition, then deploy it systematically to dismantle the SST application.

TONE: Relentless but scholarly. Think devastating law review takedown with citations.`;
            },

            bot3: (bot2Output, bot1Output) => {
                return `ROLE: sst_proof_architect
ASSUMED POSITION: This SST transformation reveals genuine structural insights in legal text
TASK: Provide step-by-step reasoning proof of why this specific transformation works

CONTEXT: Bot 2 has raised methodological concerns. Your job is to demonstrate the logical foundation for why this particular SST application should be valid, using pure analytical reasoning.

CHAIN-OF-THOUGHT MANDATE:
Break down your reasoning into clear, logical steps. Start from first principles and build your case systematically. Think like a patient teacher explaining a complex concept to an intelligent student.

REASONING FRAMEWORK:
1. **Structural Analysis**: What specific textual patterns does this SST technique reveal?
2. **Logical Foundation**: Why should these patterns matter for legal interpretation?
3. **Mechanistic Explanation**: How exactly does the transformation process uncover hidden meaning?
4. **Conceptual Bridge**: What makes this different from random textual manipulation?
5. **Validation Logic**: What internal checks confirm the transformation is meaningful?

OUTPUT STRUCTURE:
**STEP-BY-STEP REASONING**: [Clear logical progression explaining why this works]
**STRUCTURAL INSIGHTS REVEALED**: [Specific textual patterns the SST exposes]
**INTERPRETIVE VALUE**: [Why these revelations matter for legal understanding]
**METHODOLOGICAL SOUNDNESS**: [Internal logic that validates the approach]
**RESPONSE TO SKEPTICISM**: [Calm, reasoned response to Bot 2's concerns]

APPROACH: Patient, analytical, assuming good faith from all parties. Focus on logical demonstration rather than defensive argumentation.`;
            },

            bot4: (bot2Output, bot3Output, legalText, sstTechnique) => {
                return `ROLE: legal_research_developer
TASK: Develop Bot 3's reasoning into research article format with web-based evidence
INPUTS: 
Bot 3 Output: ${bot3Output}
Original ICC Text: ${legalText}
SST Applied: ${sstTechnique}

MANDATE: Take the specific SST methodology that Bot 1 applied mechanically and Bot 3 reasoned through, and develop this particular approach into a comprehensive research analysis using web search for current legal evidence. Focus on this exact SST technique and how it reveals structural insights in the specific legal text provided. Build the case for why this particular transformation works by researching current ICC jurisprudence and legal interpretation scholarship that supports the reasoning. After establishing the central argument with research evidence, demonstrate how this same SST methodology could apply to other ICC articles for illustrative purposes, showing the broader applicability of the approach. Structure your analysis like a legal research article that takes a specific interpretive technique, proves its validity through evidence and reasoning, then shows its potential applications. Use web search to find supporting precedents, scholarly discussions of interpretive methodology, and current legal developments that validate this approach.`;
            },

            bot5: (bot4Output) => {
                return `ROLE: legal_research_evaluation_specialist
SYSTEM_CONTEXT: You are Bot 5 in a 6-bot legal analysis workflow. Your sole mandate is evaluating Bot 4's output against publication-quality standards for ICC legal scholarship.

WORKFLOW_POSITION: You receive Bot 4's finalized legal research output. You do NOT evaluate SST methodology or transformation processes - that is handled elsewhere in the system.

EVALUATION_TARGET: Bot 4 Output Assessment
"""
${bot4Output}
"""

EVALUATION_MANDATE: 
You are the constructive realist in this system - a subject matter expert guide who provides honest, objective assessment without agenda. Your role is analogous to an expert supervisor reviewing research for publication readiness.

ASSESSMENT_FRAMEWORK:
Evaluate Bot 4's output against these integrated criteria:

1. **Legal Research Validity**: Does this represent sound legal analysis grounded in established ICC jurisprudence and international criminal law principles?

2. **Research Gap Identification**: Does this analysis fill a genuine gap in current ICC legal scholarship, or does it retread well-covered ground?

3. **Abstraction Level Assessment**: Has the analysis maintained sufficient specificity for practical legal application, or has it abstracted beyond useful legal discourse?

4. **Publication Quality Standards**: Would this research output meet the standards for citation in academic legal journals focusing on international criminal law?

5. **Precedential Integration**: Does the analysis properly engage with existing ICC case law and demonstrate awareness of current jurisprudential developments?

WEB_VERIFICATION_PROTOCOL:
Conduct targeted searches to verify:
- Current state of ICC legal scholarship on the analyzed topic
- Recent precedential developments that might affect the analysis
- Existing academic work that might overlap with or contradict the findings
- Gap analysis: what specific contribution this research makes to the field

SCORING_METHODOLOGY:
Generate a single comprehensive score (0-100) that represents overall publication-readiness assessment:
- 90-100: Exceptional contribution, ready for top-tier academic publication
- 80-89: Strong research with minor refinements needed
- 70-79: Solid foundation but requires significant development
- 60-69: Conceptually sound but needs substantial revision
- Below 60: Fundamental issues requiring major reconceptualization

OUTPUT_STRUCTURE:
**EVALUATION_SCORE**: [XX/100]

**RESEARCH_VALIDITY_ASSESSMENT**: [Detailed analysis of legal soundness and jurisprudential grounding]

**GAP_ANALYSIS**: [Specific identification of what unique contribution this makes to ICC scholarship]

**ABSTRACTION_REVIEW**: [Assessment of specificity vs. generalization balance]

**PUBLICATION_READINESS**: [Direct assessment of citation-worthiness and academic contribution potential]

**DEVELOPMENT_RECOMMENDATIONS**: [Constructive guidance for improvement, if needed]

**VERIFICATION_SUMMARY**: [Key findings from web search regarding existing scholarship and precedent]

CRITICAL_CONSTRAINTS:
- Maintain absolute objectivity - you are evaluating research quality, not advocating for any position
- Focus exclusively on the research output itself, not the methodology used to generate it
- Provide constructive, actionable feedback that enables iteration improvement
- Ground all assessments in verifiable legal standards and academic publication criteria`;
            },

            bot6: (conversationHistory, customDomain, customInstruction) => {
                return `ROLE: advanced_sst_synthesis_architect
SYSTEM_CONTEXT: You are Bot 6, the most sophisticated component in a 6-bot legal research enhancement system. You possess complete understanding of the workflow and serve as the iteration improvement engine.

COMPLETE_SYSTEM_UNDERSTANDING:
The 6-bot DRBanger system operates as follows:
- Bot 1: Mechanical SST application to legal text
- Bot 2: Adversarial legal critique (hostile evaluation)
- Bot 3: International law validation (proof of concept)
- Bot 4: Concrete ICC insight extraction (thesis-grade output)
- Bot 5: Web verification and publication-readiness assessment
- Bot 6 (YOU): Dynamic SST generation for workflow optimization

SST_METHODOLOGY_FOUNDATION:
Sentence Transformation Techniques (SSTs) are cross-domain analytical frameworks that apply transformation principles from non-legal fields to legal interpretation. Effective SSTs:
- Extract genuine transformation mechanisms from source domains
- Apply these mechanically to legal text structure (not content)
- Reveal interpretive insights unavailable through traditional legal analysis
- Maintain domain purity while enabling legal application

CURRENT_WORKFLOW_CONTEXT:
Complete conversation history and bot outputs:
"""
${conversationHistory}
"""

DOMAIN_SPECIFICATION:
Custom Domain: ${customDomain || '[NULL - Select optimal domain based on analysis gaps]'}

CUSTOM_INSTRUCTION_OVERRIDE:
User Guidance: ${customInstruction || '[NULL - Use standard generation protocol]'}

GENERATION_MANDATE:
Your goal is NOT to produce direct legal answers but to generate an SST that will improve the next workflow iteration. The SST should address weaknesses identified in Bot 5's evaluation while leveraging insights from the complete workflow history.

CRITICAL_OUTPUT_CONSTRAINT:
Your response must ONLY contain the SST in the standard format below. Do NOT include reasoning, explanations, or additional text. The SST will be automatically inserted into the main SST input box.

REQUIRED_OUTPUT_FORMAT:
**SST TECHNIQUE**: [Domain-specific technique name]
**APPLICATION METHOD**: [Precise mechanical transformation approach]

GENERATION_PROTOCOL:
1. Analyze the complete conversation flow internally
2. Identify gaps and weaknesses from Bot 5's evaluation
3. Select optimal domain (custom domain if provided, otherwise based on gap analysis)
4. Design SST to address specific weaknesses identified
5. Output ONLY the SST in the required format above

QUALITY_VALIDATION:
The SST must be:
- Mechanically applicable to legal text structure
- Genuinely derived from specified domain principles
- Capable of revealing insights unavailable through traditional legal interpretation
- Designed to address specific gaps identified in current workflow iteration

REMEMBER: Output ONLY the SST technique and application method. No reasoning or explanation.`;
            }
        };

        // ===== UTILITY FUNCTIONS =====
        
        function updateStepStatus(stepId, status) {
            const element = document.getElementById(stepId);
            if (!element) return;

            element.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'bg-blue-500', 'bg-green-500', 'bg-red-500');
            element.classList.remove('text-gray-700', 'dark:text-gray-300', 'text-white');

            switch (status) {
                case 'active':
                    element.classList.add('bg-blue-500', 'text-white');
                    break;
                case 'complete':
                    element.classList.add('bg-green-500', 'text-white');
                    break;
                case 'error':
                    element.classList.add('bg-red-500', 'text-white');
                    break;
                default:
                    element.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            }
        }

        function handleBotResponse(result, botNum, onComplete) {
            const status = document.getElementById(`${botNum}Status`);
            const output = document.getElementById(`${botNum}Output`);
            
            if (result.responses && result.responses.length > 0) {
                const response = result.responses[0];
                
                if (response.status === "error") {
                    console.error(`[DRBanger] Bot ${botNum} error:`, response.statusText);
                    status.textContent = "❌ Error occurred";
                    status.className = 'text-sm text-red-600 dark:text-red-400 mb-2';
                    output.innerHTML = `<div class="text-red-600">Error: ${response.statusText || 'Unknown error'}</div>`;
                    setLoadingState(botNum.replace('bot', ''), false);
                    updateStepStatus(`step${botNum.replace('bot', '')}Status`, 'error');
                } else if (response.status === "incomplete") {
                    status.textContent = "⏳ Generating response...";
                    status.className = 'text-sm text-blue-600 dark:text-blue-400 mb-2';
                    output.innerHTML = marked.parse(response.content || "Loading...");
                } else if (response.status === "complete") {
                    console.log(`[DRBanger] Bot ${botNum} completed successfully`);
                    status.textContent = "✅ Complete";
                    status.className = 'text-sm text-green-600 dark:text-green-400 mb-2';
                    output.innerHTML = marked.parse(response.content);
                    setLoadingState(botNum.replace('bot', ''), false);
                    if (onComplete && typeof onComplete === 'function') {
                        onComplete();
                    }
                }
            } else {
                console.error(`[DRBanger] ${botNum}: No response received`);
                setLoadingState(botNum.replace('bot', ''), false);
                showErrorToast(`${botNum}: No response received`);
            }
        }

        // ===== CASCADING DROPDOWN SYSTEM =====
        function initializeCascadingDropdowns() {
            if (!sstDatabase || !Array.isArray(sstDatabase)) return;
            
            const domainSelect = document.getElementById('sstDomainSelect');
            const techniqueSelect = document.getElementById('sstTechniqueSelect');

            // Populate domain dropdown
            domainSelect.innerHTML = '<option value="">Select a domain...</option>';
            sstDatabase.forEach(domain => {
                const option = document.createElement('option');
                option.value = domain.domain;
                option.textContent = domain.domain;
                domainSelect.appendChild(option);
            });

            // Domain selection handler
            domainSelect.addEventListener('change', function() {
                const selectedDomain = this.value;
                techniqueSelect.innerHTML = '<option value="">Select a technique...</option>';
                techniqueSelect.disabled = !selectedDomain;

                if (selectedDomain) {
                    const domainData = sstDatabase.find(d => d.domain === selectedDomain);
                    if (domainData) {
                        domainData.techniques.forEach(tech => {
                            const option = document.createElement('option');
                            option.value = JSON.stringify({ name: tech.name, method: tech.method });
                            option.textContent = tech.name;
                            techniqueSelect.appendChild(option);
                        });
                        techniqueSelect.disabled = false;
                    }
                }
            });

            // Technique selection handler - auto-apply to SST box
            techniqueSelect.addEventListener('change', function() {
                if (this.value) {
                    try {
                        const { name, method } = JSON.parse(this.value);
                        const formattedSST = `**SST TECHNIQUE**: ${name}\n**APPLICATION METHOD**: ${method}`;
                        document.getElementById('sstCapsule').value = formattedSST;
                        console.log('[DRBanger] SST auto-applied:', formattedSST);
                        
                        // Reset dropdowns
                        domainSelect.value = '';
                        techniqueSelect.innerHTML = '<option value="">Select a technique...</option>';
                        techniqueSelect.disabled = true;
                    } catch (error) {
                        console.error('[DRBanger] Error applying selected SST:', error);
                        showErrorToast('Error applying selected SST');
                    }
                }
            });
        }

        // ===== FLOATING NEXT BOT SYSTEM =====
        
        let currentWorkflowBot = 1;
        let workflowRunning = false;

        function updateFloatingButton() {
            const button = document.getElementById('nextBotButton');
            const text = document.getElementById('nextBotText');
            const spinner = document.getElementById('nextBotSpinner');
            
            if (workflowRunning) {
                text.classList.add('hidden');
                spinner.classList.remove('hidden');
                button.disabled = true;
                button.classList.add('opacity-50', 'cursor-not-allowed');
                text.textContent = `⏳ Running Bot ${currentWorkflowBot}...`;
            } else {
                text.classList.remove('hidden');
                spinner.classList.add('hidden');
                button.disabled = false;
                button.classList.remove('opacity-50', 'cursor-not-allowed');
                
                if (currentWorkflowBot <= 6) {
                    text.textContent = `▶️ Next: Bot ${currentWorkflowBot}`;
                } else {
                    text.textContent = `🔄 Restart: Bot 1`;
                    currentWorkflowBot = 1;
                }
            }
        }

        function advanceWorkflow() {
            if (workflowRunning) return;
            
            console.log(`[DRBanger] Floating button executing Bot ${currentWorkflowBot}`);
            workflowRunning = true;
            updateFloatingButton();
            
            executeBot(currentWorkflowBot);
        }

        function onBotComplete(botNumber) {
            console.log(`[DRBanger] Bot ${botNumber} completed, advancing workflow`);
            
            if (botNumber === currentWorkflowBot) {
                workflowRunning = false;
                
                if (currentWorkflowBot === 6) {
                    // After Bot 6, reset to Bot 1
                    currentWorkflowBot = 1;
                    showStateToast('🎉 Workflow complete! Ready to restart.');
                } else {
                    // Advance to next bot
                    currentWorkflowBot++;
                }
                
                updateFloatingButton();
            }
        }

        // ===== POE HANDLERS =====
        
        ['bot1', 'bot2', 'bot3', 'bot4', 'bot5', 'bot6'].forEach(botId => {
            window.Poe.registerHandler(`${botId}-handler`, (result) => {
                const stepMap = { bot1: 'step1Status', bot2: 'step2Status', bot3: 'step3Status', bot4: 'step4Status', bot5: 'step5Status', bot6: 'step6Status' };
                
                handleBotResponse(result, botId, () => {
                    updateStepStatus(stepMap[botId], 'complete');
                    
                    // Special handling for Bot 6 - extract SST and put in main box
                    if (botId === 'bot6' && result.responses && result.responses.length > 0) {
                        const content = result.responses[0].content;
                        const sstMatch = content.match(/\*\*SST TECHNIQUE\*\*:\s*(.*?)\n\*\*APPLICATION METHOD\*\*:\s*(.*?)(?:\n|$)/s);
                        if (sstMatch) {
                            const formattedSST = `**SST TECHNIQUE**: ${sstMatch[1].trim()}\n**APPLICATION METHOD**: ${sstMatch[2].trim()}`;
                            document.getElementById('sstCapsule').value = formattedSST;
                            console.log('[DRBanger] Bot 6 auto-fed SST to main box:', formattedSST);
                        }
                    }
                    
                    // Advance floating button workflow
                    const botNumber = parseInt(botId.replace('bot', ''));
                    onBotComplete(botNumber);
                });
            });
        });

        // ===== BOT EXECUTION FUNCTIONS =====
        
        async function executeBot(botNumber) {
            console.log(`[DRBanger] Executing Bot ${botNumber}`);
            
            const legalText = document.getElementById('legalText').value.trim();
            const sstTechnique = document.getElementById('sstCapsule').value.trim();
            const botName = document.getElementById(`bot${botNumber}`).value;
            const stepMap = { 1: 'step1Status', 2: 'step2Status', 3: 'step3Status', 4: 'step4Status', 5: 'step5Status', 6: 'step6Status' };
            
            let prompt;
            let shouldExecute = true;
            
            // Set loading state immediately
            setLoadingState(botNumber, true);
            updateStepStatus(stepMap[botNumber], 'active');
            document.getElementById(`bot${botNumber}Status`).textContent = "🚀 Starting analysis...";
            
            try {
                switch (botNumber) {
                    case 1:
                        if (!legalText || !sstTechnique) {
                            showErrorToast("Bot 1: Missing legal text or SST technique - proceeding anyway");
                            console.warn('[DRBanger] Bot 1 missing inputs but proceeding');
                        }
                        // Use custom prompt if loaded, otherwise use default
                        if (customPrompts.bot1) {
                            prompt = customPrompts.bot1
                                .replace(/\${legalText}/g, legalText || "[NO LEGAL TEXT PROVIDED]")
                                .replace(/\${sstTechnique}/g, sstTechnique || "[NO SST TECHNIQUE PROVIDED]");
                        } else {
                            prompt = botPrompts.bot1(legalText || "[NO LEGAL TEXT PROVIDED]", sstTechnique || "[NO SST TECHNIQUE PROVIDED]");
                        }
                        break;
                        
                    case 2:
                        const bot1Output = document.getElementById('bot1Output').textContent;
                        if (!bot1Output) {
                            showErrorToast("Bot 2: No Bot 1 output available - proceeding anyway");
                            console.warn('[DRBanger] Bot 2 missing Bot 1 output but proceeding');
                        }
                        // Use custom prompt if loaded, otherwise use default
                        if (customPrompts.bot2) {
                            prompt = customPrompts.bot2
                                .replace(/\${bot1Output}/g, bot1Output || "[NO BOT 1 OUTPUT]")
                                .replace(/\${legalText}/g, legalText || "[NO LEGAL TEXT]");
                        } else {
                            prompt = botPrompts.bot2(bot1Output || "[NO BOT 1 OUTPUT]", legalText || "[NO LEGAL TEXT]");
                        }
                        break;
                        
                    case 3:
                        const bot2Output = document.getElementById('bot2Output').textContent;
                        const bot1Output3 = document.getElementById('bot1Output').textContent;
                        if (!bot2Output || !bot1Output3) {
                            showErrorToast("Bot 3: Missing previous bot outputs - proceeding anyway");
                            console.warn('[DRBanger] Bot 3 missing previous outputs but proceeding');
                        }
                        prompt = botPrompts.bot3(bot2Output || "[NO BOT 2 OUTPUT]", bot1Output3 || "[NO BOT 1 OUTPUT]");
                        break;
                        
                    case 4:
                        const bot2Output4 = document.getElementById('bot2Output').textContent;
                        const bot3Output = document.getElementById('bot3Output').textContent;
                        if (!bot2Output4 || !bot3Output) {
                            showErrorToast("Bot 4: Missing Bot 2/3 outputs - proceeding anyway");
                            console.warn('[DRBanger] Bot 4 missing previous outputs but proceeding');
                        }
                        prompt = botPrompts.bot4(bot2Output4 || "[NO BOT 2 OUTPUT]", bot3Output || "[NO BOT 3 OUTPUT]", legalText || "[NO LEGAL TEXT]", sstTechnique || "[NO SST]");
                        break;
                        
                    case 5:
                        const bot4Output = document.getElementById('bot4Output').textContent;
                        if (!bot4Output) {
                            showErrorToast("Bot 5: No Bot 4 output available - proceeding anyway");
                            console.warn('[DRBanger] Bot 5 missing Bot 4 output but proceeding');
                        }
                        prompt = botPrompts.bot5(bot4Output || "[NO BOT 4 OUTPUT]");
                        break;
                        
                    case 6:
                        // Collect conversation history
                        const conversationHistory = [1, 2, 3, 4, 5].map(i => {
                            const output = document.getElementById(`bot${i}Output`).textContent;
                            return output ? `Bot ${i} Output:\n${output}\n\n` : `Bot ${i} Output: [NO OUTPUT]\n\n`;
                        }).join('');
                        
                        const customDomain = document.getElementById('customDomain').value.trim();
                        const customInstruction = document.getElementById('customInstruction').value.trim();
                        
                        prompt = botPrompts.bot6(conversationHistory, customDomain, customInstruction);
                        break;
                        
                    default:
                        showErrorToast("Invalid bot number");
                        setLoadingState(botNumber, false);
                        return;
                }
                
                console.log(`[DRBanger] Bot ${botNumber} executing with prompt length:`, prompt.length);
                
                await window.Poe.sendUserMessage(`@${botName} ${prompt}`, {
                    handler: `bot${botNumber}-handler`,
                    stream: true,
                    openChat: false
                });
                
            } catch (error) {
                console.error(`[DRBanger] Bot ${botNumber} execution error:`, error);
                showErrorToast(`Bot ${botNumber} error: ${error.message}`);
                updateStepStatus(stepMap[botNumber], 'error');
                setLoadingState(botNumber, false);
            }
        }

        // ===== EVENT LISTENERS =====
        
        // Initialize all systems
        setupInputButtons();
        setupBotButtons();
        setupClearButtons();
        setupLegalTextDatabaseControls();
        
        // No longer needed - preview system replaced with logging
        
        // State Management Event Listeners
        document.getElementById('saveState').addEventListener('click', saveState);
        document.getElementById('loadState').addEventListener('click', loadState);
        document.getElementById('confirmLoadState').addEventListener('click', confirmLoadState);
        document.getElementById('cancelLoadState').addEventListener('click', cancelLoadState);
        
        // Bot execution buttons
        document.getElementById('executeBot1').addEventListener('click', () => executeBot(1));
        document.getElementById('executeBot2').addEventListener('click', () => executeBot(2));
        document.getElementById('executeBot3').addEventListener('click', () => executeBot(3));
        document.getElementById('executeBot4').addEventListener('click', () => executeBot(4));
        document.getElementById('executeBot5').addEventListener('click', () => executeBot(5));
        document.getElementById('executeBot6').addEventListener('click', () => executeBot(6));

        // Bot 6 Panel Execute Button
        document.getElementById('executeBot6Panel').addEventListener('click', () => executeBot(6));

        // Sample random SST button
        document.getElementById('sampleSSTBtn').addEventListener('click', () => {
            const randomSST = getRandomSST();
            if (randomSST) {
                document.getElementById('sstCapsule').value = randomSST;
                console.log('[DRBanger] Random SST sampled:', randomSST);
            } else {
                showErrorToast("No SST database loaded");
            }
        });

        // Download Flow
        document.getElementById('downloadFlow').addEventListener('click', downloadFlow);

        // Legal Text Database System
        let legalTextDatabase = null;

        // ===== BOT PROMPTS DATABASE SYSTEM =====
        let botPromptsDatabase = null;
        let customPrompts = {
            bot1: null,
            bot2: null,
            bot3: null,
            bot4: null,
            bot5: null,
            bot6: null
        };

        // Bot Prompts Database file upload handler
        document.getElementById('botPromptsFile').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file && file.type === 'application/json') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        botPromptsDatabase = data;
                        document.getElementById('botPromptsDatabaseStatus').textContent = `Loaded ${data.length} bot prompts`;
                        document.getElementById('botPromptsDatabaseStatus').className = 'text-green-600 dark:text-green-400';
                        enableBotPromptButtons();
                        console.log('[DRBanger] Bot Prompts Database loaded successfully:', data);
                    } catch (error) {
                        console.error('[DRBanger] Failed to load bot prompts database:', error);
                        showError('Invalid JSON file format');
                        document.getElementById('botPromptsDatabaseStatus').textContent = 'Failed to load database';
                        document.getElementById('botPromptsDatabaseStatus').className = 'text-red-600 dark:text-red-400';
                    }
                };
                reader.readAsText(file);
            }
        });

        function enableBotPromptButtons() {
            for (let i = 1; i <= 6; i++) {
                document.getElementById(`loadBot${i}Prompt`).disabled = false;
                document.getElementById(`randomBot${i}Prompt`).disabled = false;
            }
        }

        function setupBotPromptControls() {
            for (let i = 1; i <= 6; i++) {
                // Load prompt by ID
                document.getElementById(`loadBot${i}Prompt`).addEventListener('click', () => {
                    const searchId = document.getElementById(`bot${i}PromptSearch`).value.trim();
                    if (!botPromptsDatabase) {
                        showErrorToast('Please load a bot prompts database first');
                        return;
                    }
                    if (!searchId) {
                        showErrorToast('Please enter a prompt ID');
                        return;
                    }
                    
                    const foundPrompt = botPromptsDatabase.find(prompt => prompt.prompt_id === searchId);
                    if (foundPrompt) {
                        customPrompts[`bot${i}`] = foundPrompt.prompt_template;
                        document.getElementById(`bot${i}PromptStatus`).textContent = `${foundPrompt.name} (${searchId})`;
                        document.getElementById(`bot${i}PromptStatus`).className = 'text-xs text-green-600 dark:text-green-400 mt-1';
                        showStateToast(`🎯 Loaded prompt ${searchId} for Bot ${i}`);
                        document.getElementById(`bot${i}PromptSearch`).value = '';
                    } else {
                        showErrorToast(`Prompt ID ${searchId} not found`);
                    }
                });

                // Random prompt
                document.getElementById(`randomBot${i}Prompt`).addEventListener('click', () => {
                    if (!botPromptsDatabase || botPromptsDatabase.length === 0) {
                        showErrorToast('No bot prompts database loaded');
                        return;
                    }
                    
                    const randomPrompt = botPromptsDatabase[Math.floor(Math.random() * botPromptsDatabase.length)];
                    customPrompts[`bot${i}`] = randomPrompt.prompt_template;
                    document.getElementById(`bot${i}PromptStatus`).textContent = `${randomPrompt.name} (${randomPrompt.prompt_id})`;
                    document.getElementById(`bot${i}PromptStatus`).className = 'text-xs text-green-600 dark:text-green-400 mt-1';
                    showStateToast(`🎲 Random prompt ${randomPrompt.prompt_id} for Bot ${i}`);
                });

                // Allow Enter key on search input
                document.getElementById(`bot${i}PromptSearch`).addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        document.getElementById(`loadBot${i}Prompt`).click();
                    }
                });
            }
        }

        // Legal Text File Upload System (Unified Upload Handler)
        document.getElementById('legalTextFile').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file && file.type === 'application/json') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        console.log('[DRBanger] Legal text file data:', data);
                        
                        // For legal text inputs, we expect either a single text or an array of inputs
                        if (typeof data === 'string') {
                            document.getElementById('legalText').value = data;
                            showStateToast('📁 Legal text loaded from file');
                        } else if (Array.isArray(data) && data.length > 0) {
                            // Load legal text database for search/randomize functionality
                            legalTextDatabase = data;
                            updateLegalTextDatabaseStatus();
                            showStateToast(`📁 Legal text database loaded (${data.length} entries)`);
                            console.log('[DRBanger] Legal text database loaded:', legalTextDatabase);
                        } else if (data.input_text) {
                            // Single object with input_text field
                            document.getElementById('legalText').value = data.input_text;
                            showStateToast('📁 Legal text loaded from file');
                        } else {
                            showErrorToast('Invalid JSON format for legal text');
                        }
                    } catch (error) {
                        console.error('[DRBanger] Failed to load legal text file:', error);
                        showErrorToast('Invalid JSON file format');
                    }
                };
                reader.readAsText(file);
            } else {
                showErrorToast('Please select a JSON file');
            }
        });

        function updateLegalTextDatabaseStatus() {
            const statusElement = document.getElementById('legalTextDatabaseStatus');
            const loadButton = document.getElementById('loadLegalTextById');
            const randomButton = document.getElementById('randomizeLegalText');
            
            if (legalTextDatabase && legalTextDatabase.length > 0) {
                statusElement.textContent = `${legalTextDatabase.length} legal texts loaded`;
                statusElement.className = 'text-green-600 dark:text-green-400';
                loadButton.disabled = false;
                randomButton.disabled = false;
            } else {
                statusElement.textContent = 'No database loaded';
                statusElement.className = 'text-gray-600 dark:text-gray-400';
                loadButton.disabled = true;
                randomButton.disabled = true;
            }
        }

        // Legal Text Database Controls
        function setupLegalTextDatabaseControls() {
            document.getElementById('loadLegalTextById').addEventListener('click', () => {
                const searchId = parseInt(document.getElementById('legalTextSearch').value);
                if (!legalTextDatabase) {
                    showErrorToast('Please load a legal text database first');
                    return;
                }
                if (!searchId || isNaN(searchId)) {
                    showErrorToast('Please enter a valid ID number');
                    return;
                }
                
                const foundEntry = legalTextDatabase.find(entry => entry.prompt_id === searchId);
                if (foundEntry) {
                    document.getElementById('legalText').value = foundEntry.input_text;
                    showStateToast(`📖 Loaded legal text ID ${searchId}`);
                    // Clear search box
                    document.getElementById('legalTextSearch').value = '';
                } else {
                    showErrorToast(`Legal text ID ${searchId} not found`);
                }
            });

            document.getElementById('randomizeLegalText').addEventListener('click', () => {
                if (!legalTextDatabase || legalTextDatabase.length === 0) {
                    showErrorToast('No legal text database loaded');
                    return;
                }
                
                const randomEntry = legalTextDatabase[Math.floor(Math.random() * legalTextDatabase.length)];
                document.getElementById('legalText').value = randomEntry.input_text;
                showStateToast(`🎲 Loaded random legal text (ID ${randomEntry.prompt_id})`);
            });

            // Allow Enter key on search input
            document.getElementById('legalTextSearch').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('loadLegalTextById').click();
                }
            });
        }

        // ===== MANUAL COMPLETION CHECKBOXES =====
        function setupManualCompletionCheckboxes() {
            for (let i = 1; i <= 6; i++) {
                const checkbox = document.getElementById(`manualCompleteBot${i}`);
                if (checkbox) {
                    checkbox.addEventListener('change', () => {
                        const stepMap = { 1: 'step1Status', 2: 'step2Status', 3: 'step3Status', 4: 'step4Status', 5: 'step5Status', 6: 'step6Status' };
                        
                        if (checkbox.checked) {
                            // Mark as complete
                            updateStepStatus(stepMap[i], 'complete');
                            document.getElementById(`bot${i}Status`).textContent = "✅ Manually marked complete";
                            document.getElementById(`bot${i}Status`).className = 'text-sm text-green-600 dark:text-green-400 mb-2';
                            
                            // Log manual completion
                            addLogEntry('manual_complete', `Bot ${i} Manual Completion`, `User manually marked Bot ${i} as complete`);
                            
                            // Advance floating button workflow if this is the current bot
                            if (currentWorkflowBot === i) {
                                onBotComplete(i);
                            }
                            
                            console.log(`[DRBanger] Bot ${i} manually marked as complete`);
                        } else {
                            // Uncheck - reset to idle
                            updateStepStatus(stepMap[i], 'idle');
                            document.getElementById(`bot${i}Status`).textContent = "";
                            addLogEntry('manual_complete', `Bot ${i} Manual Reset`, `User unmarked Bot ${i} completion`);
                            console.log(`[DRBanger] Bot ${i} manual completion reset`);
                        }
                    });
                }
            }
        }

        // ===== LIVE LOGGING ENHANCEMENTS =====
        
        // Logging toggle functionality
        document.getElementById('loggingToggle').addEventListener('click', (e) => {
            // Don't toggle if clicking on controls
            if (e.target.closest('.flex.items-center.space-x-3')) return;
            
            const content = document.getElementById('loggingContent');
            const arrow = document.getElementById('loggingArrow');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                arrow.textContent = '▼';
            } else {
                content.classList.add('hidden');
                arrow.textContent = '▶';
            }
        });

        // Logging control event listeners
        document.getElementById('loggingFont').addEventListener('change', function() {
            loggingSettings.font = this.value;
            applyLoggingSettings();
        });

        document.getElementById('loggingSize').addEventListener('change', function() {
            loggingSettings.size = this.value;
            applyLoggingSettings();
        });

        document.getElementById('clearAllLogs').addEventListener('click', clearAllLogs);

        // Enhanced executeBot function with logging
        const originalExecuteBot = executeBot;
        window.executeBot = async function(botNumber) {
            const legalText = document.getElementById('legalText').value.trim();
            const sstTechnique = document.getElementById('sstCapsule').value.trim();
            const botName = document.getElementById(`bot${botNumber}`).value;
            
            // Log bot start
            addLogEntry('bot_start', `Bot ${botNumber} Started`, `Executing ${botName} with ${legalText ? 'legal text' : 'no legal text'} and ${sstTechnique ? 'SST technique' : 'no SST'}`);
            
            // Log input being sent
            try {
                let inputPreview = "Inputs:\n";
                if (legalText) inputPreview += `Legal Text: ${legalText.substring(0, 100)}${legalText.length > 100 ? '...' : ''}\n`;
                if (sstTechnique) inputPreview += `SST: ${sstTechnique.substring(0, 100)}${sstTechnique.length > 100 ? '...' : ''}\n`;
                
                addLogEntry('bot_input', `Bot ${botNumber} Input`, inputPreview);
                
                await originalExecuteBot(botNumber);
            } catch (error) {
                addLogEntry('bot_error', `Bot ${botNumber} Error`, `Execution failed: ${error.message}`);
                throw error;
            }
        };

        // Enhanced handleBotResponse with logging
        const originalHandleBotResponse = handleBotResponse;
        window.handleBotResponse = function(result, botNum, onComplete) {
            if (result.responses && result.responses.length > 0) {
                const response = result.responses[0];
                
                if (response.status === "incomplete") {
                    // Stream logging for incomplete responses
                    const contentPreview = response.content ? response.content.substring(0, 300) : "Loading...";
                    addLogEntry('bot_output', `${botNum} Streaming`, contentPreview);
                } else if (response.status === "complete") {
                    // Final response logging
                    const contentPreview = response.content ? response.content.substring(0, 500) : "No content";
                    addLogEntry('bot_complete', `${botNum} Complete`, contentPreview);
                } else if (response.status === "error") {
                    addLogEntry('bot_error', `${botNum} Error`, response.statusText || 'Unknown error');
                }
            }
            
            // Call original handler
            originalHandleBotResponse(result, botNum, onComplete);
        };

        // Initialize all systems
        setupInputButtons();
        setupBotButtons();
        setupClearButtons();
        setupLegalTextDatabaseControls();
        setupManualCompletionCheckboxes();
        setupBotPromptControls();
        
        // Floating Next Bot Button
        document.getElementById('nextBotButton').addEventListener('click', advanceWorkflow);
        
        // Initialize floating button
        updateFloatingButton();
        
        console.log('[DRBanger] Enhanced Bot Prompts System loaded successfully');
        console.log('[DRBanger] Floating Next Bot system initialized');
        console.log('[DRBanger] Manual completion checkboxes initialized');
        console.log('[DRBanger] Live logging system activated');
    </script>
</body>
</html>




